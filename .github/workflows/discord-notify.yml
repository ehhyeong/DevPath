name: Discord Notifications

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
  workflow_run:
    workflows: ["CI"]   # 너희 CI 워크플로 이름에 맞게 바꿔줘 (예: "build", "test")
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # PR 열림/업데이트
      - name: PR Opened/Updated
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          username: GitHub PR
          severity: info
          title: PR ${{ github.event.action }}
          details: |
            #${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}
            by ${{ github.event.pull_request.user.login }}
            ${{ github.event.pull_request.html_url }}

      # PR 닫힘(머지/클로즈)
      - name: PR Closed
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          username: GitHub PR
          severity: ${{ github.event.pull_request.merged && 'info' || 'warn' }}
          title: PR closed (${{ github.event.pull_request.merged && 'merged' || 'not merged' }})
          details: |
            #${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.html_url }}

      # CI 결과(성공/실패)
      - name: CI Result
        if: github.event_name == 'workflow_run'
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          username: GitHub Actions
          severity: ${{ github.event.workflow_run.conclusion == 'success' && 'info' || 'error' }}
          title: CI ${{ github.event.workflow_run.conclusion }}
          details: |
            Workflow: ${{ github.event.workflow_run.name }}
            Repo: ${{ github.repository }}
            ${{ github.event.workflow_run.html_url }}